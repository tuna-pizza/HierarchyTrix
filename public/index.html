<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Clusterix</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link
      href="https://fonts.googleapis.com/css2?family=VT323&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="styles.css" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script type="module" src="js/client.js" defer></script>
  </head>
  <body>
    <header
      id="main-header-container"
      style="background-color: var(--color-background-medium)"
    >
      <div style="display: flex; align-items: center; gap: 4px">
        <img
          src="clusterix_final.png"
          alt="Clusterix Icon"
          class="header-icon"
          style="height: 45px; width: 45px; vertical-align: left"
        />
        <h1>Clusterix</h1>
      </div>

      <div style="display: flex; gap: 15px; align-items: center">
        <fieldset id="zoom-controls">
          <span style="font-size: 0.9rem; font-weight: normal; margin-left: 2px"
            >Zoom:</span
          >
          <button id="zoom-out-button" class="zoom-button">-</button>
          <button id="zoom-reset-button" class="zoom-button">Full view</button>
          <button id="zoom-in-button" class="zoom-button">+</button>
        </fieldset>

        <button id="uploadButton">Upload JSON</button>
        <input
          type="file"
          id="fileInput"
          accept=".json"
          style="display: none"
        />

        <fieldset>
          <div
            id="instance-selector"
            style="
              display: flex;
              align-items: center;
              gap: 5px;
              position: relative;
            "
          >
            <input
              type="text"
              id="instance-id-input-header"
              placeholder="Instance ID"
            />

            <div id="samples-popover-container" style="position: relative">
              <button id="sample-button">
                Instance <span style="font-size: 0.7em">&#x25BC;</span>
              </button>

              <div
                id="sample-dropdown"
                style="
                  display: none;
                  position: absolute;
                  top: 100%;
                  left: 0px;
                  width: 120px;
                  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
                  z-index: 200;
                "
              >
                <a
                  data-instance="animals"
                  href="#"
                  style="
                    padding: 8px 10px;
                    text-decoration: none;
                    display: block;
                    font-size: 0.9rem;
                  "
                  >animals</a
                >
                <a
                  data-instance="sample"
                  href="#"
                  style="
                    padding: 8px 10px;
                    text-decoration: none;
                    display: block;
                    font-size: 0.9rem;
                  "
                  >sample</a
                >
                <a
                  data-instance="paper_example"
                  href="#"
                  style="
                    padding: 8px 10px;
                    text-decoration: none;
                    display: block;
                    font-size: 0.9rem;
                  "
                  >paper_example</a
                >
                <a
                  data-instance="graph_1"
                  href="#"
                  style="
                    padding: 8px 10px;
                    text-decoration: none;
                    display: block;
                    font-size: 0.9rem;
                  "
                  >graph_1</a
                >
                <a
                  data-instance="graph_2"
                  href="#"
                  style="
                    padding: 8px 10px;
                    text-decoration: none;
                    display: block;
                    font-size: 0.9rem;
                  "
                  >graph_2</a
                >
                <a
                  data-instance="graph_3"
                  href="#"
                  style="
                    padding: 8px 10px;
                    text-decoration: none;
                    display: block;
                    font-size: 0.9rem;
                  "
                  >graph_3</a
                >
              </div>
            </div>

            <div id="solver-popover-container" style="position: relative">
              <button id="solver-button">
                Solver <span style="font-size: 0.7em">&#x25BC;</span>
              </button>

              <div
                id="solver-dropdown"
                style="
                  display: none;
                  position: absolute;
                  top: 100%;
                  left: 0;
                  width: 130px;
                  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
                  z-index: 200;
                "
              >
                <a
                  data-solver="input"
                  href="#"
                  style="
                    padding: 8px 10px;
                    text-decoration: none;
                    display: block;
                    font-size: 0.9rem;
                  "
                  >Input Order</a
                >
                <a
                  data-solver="ilp"
                  href="#"
                  style="
                    padding: 8px 10px;
                    text-decoration: none;
                    display: block;
                    font-size: 0.9rem;
                  "
                  >ILP Solver</a
                >
                <a
                  data-solver="heuristic"
                  href="#"
                  style="
                    padding: 8px 10px;
                    text-decoration: none;
                    display: block;
                    font-size: 0.9rem;
                  "
                  >Heuristic Solver</a
                >
                <a
                  data-solver="hybrid"
                  href="#"
                  style="
                    padding: 8px 10px;
                    text-decoration: none;
                    display: block;
                    font-size: 0.9rem;
                  "
                  >Hybrid Solver</a
                >
              </div>
            </div>

            <button id="go-to-instance-button">Go</button>
          </div>
        </fieldset>

        <button id="stats-toggle-button">Stats</button>

        <div
          id="loading-modal"
          style="
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.7); /* Slightly darker overlay */
          "
        >
          <div
            class="modal-content-container"
            style="
              margin: 15% auto;
              padding: 25px; /* Increased padding */
              border: 1px solid var(--color-secondary); /* Use theme color */
              width: 80%;
              max-width: 450px; /* Slightly wider */
              border-radius: 8px;
              box-shadow: 0 4px 15px rgba(0, 0, 0, 0.6); /* Deeper shadow */
              text-align: center;
              background-color: var(
                --color-background-medium
              ); /* Ensure background is defined by theme */
            "
          >
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 10px;
              "
            >
              <h2 style="margin: 0; font-size: 1.4rem">
                &#x231B; Visualization Loading...
              </h2>
              <button
                id="return-button"
                style="
                  padding: 8px 12px;
                  border: none;
                  border-radius: 5px;
                  cursor: pointer;
                  font-weight: bold;
                  background-color: var(
                    --color-secondary
                  ); /* Use secondary color for the action button */
                  color: var(--color-text-button);
                  font-family: var(--font-main);
                  transition: background-color 0.2s;
                  white-space: nowrap; /* Prevent text wrap */
                "
              >
                Cancel
              </button>
            </div>
            <hr
              style="
                border: 0;
                height: 1px;
                background: var(--color-secondary);
                margin: 15px 0;
              "
            />

            <p style="margin-top: 15px; margin-bottom: 0; font-size: 0.95rem">
              The solver is processing the request. This may take a moment.
            </p>
          </div>
        </div>

        <div id="save-viz-container" style="position: relative">
          <button id="saveVizButton">Save Visualization</button>

          <div
            id="save-viz-dropdown"
            style="
              display: none;
              position: absolute;
              top: 100%;
              right: 0;
              min-width: 150px;
              box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
              z-index: 200;
            "
          >
            <a
              data-format="svg"
              href="#"
              style="
                padding: 8px 10px;
                text-decoration: none;
                display: block;
                font-size: 0.9rem;
              "
              >Save as SVG</a
            >
            <a
              data-format="png"
              href="#"
              style="
                padding: 8px 10px;
                text-decoration: none;
                display: block;
                font-size: 0.9rem;
              "
              >Save as PNG</a
            >
            <a
              data-format="pdf"
              href="#"
              style="
                padding: 8px 10px;
                text-decoration: none;
                display: block;
                font-size: 0.9rem;
              "
              >Save as PDF</a
            >
          </div>
        </div>

        <button id="downloadButton">Download JSON</button>
      </div>
    </header>

    <div id="control-panel-container">
      <button id="control-panel-toggle-button">Show Drawing Styles</button>

      <fieldset id="control-panel">
        <legend>Drawing styles</legend>
        <div id="label-size-control" style="margin-bottom: 12px">
          <a>Label size:</a>
          <div class="slider-container">
            <input
              type="range"
              id="label-size-slider"
              min="12"
              max="30"
              value="15"
              step="1"
            />
            <span id="label-size-value" style="font-weight: normal">15px</span>
          </div>
        </div>

        <div
          id="edges-styles"
          style="
            text-decoration: none;
            display: block;
            font-size: 0.9rem;
            font-family: var(--font-main);
            font-size: 0.9rem;
            color: var(--color-secondary);
          "
        >
          <div class="toggle-container" style="margin-bottom: 12px">
            <a>Intra-cluster value:</a>
            <br />
            <label
              class="toggle-switch"
              style="
                display: flex;
                align-items: center;
                justify-content: center;
                width: 100%;
              "
            >
              <span class="toggle-label-left" style="font-weight: normal"
                >Ratio</span
              >
              <input type="checkbox" id="edge-display-toggle" />
              <span class="slider"></span>
              <span class="toggle-label-right" style="font-weight: normal"
                >Absolute</span
              >
            </label>
            <div
              id="adj-cell-legend-container"
              style="
                margin-top: 0px;
                margin-bottom: 12px;
                font-family: var(--font-main);
                font-size: 0.9rem;
              "
            ></div>
          </div>
          <div
            id="edge-legend-container"
            style="
              margin-top: 0px;
              margin-bottom: 12px;
              font-family: var(--font-main);
              font-size: 0.9rem;
            "
          ></div>
        </div>
        <div id="edge-weight-filter" style="margin-bottom: 12px; display: none">
          <a>Filter edges by weight:</a>
          <div class="slider-container">
            <input
              type="range"
              id="edge-weight-slider"
              min="0"
              max="1"
              value="0"
              step="0.1"
            />
            <span id="edge-weight-value" style="font-weight: normal">0</span>
          </div>
        </div>

        <div class="control-group">
          <div
            id="directed-legend-container"
            style="
              display: none;
              max-width: 250px;
              padding-top: 10px;
              border-top: 1px solid var(--color-secondary);
              margin-top: 10px;
            "
          >
            <div
              style="
                font-size: 0.9rem;
                margin-bottom: 8px;
                font-weight: bold;
                color: var(--color-secondary);
              "
            >
              Directed edges legend:
            </div>
            <div
              id="directed-legend-content"
              style="display: flex; flex-direction: column; font-weight: normal"
            ></div>
          </div>
        </div>
      </fieldset>
    </div>

    <div
      id="stats-panel"
      style="
        right: 20px;
        margin-top: 10px;
        background-color: var(--color-background-medium);
        border: 1px solid var(--color-secondary);
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        z-index: 100;
        max-width: 300px;
        font-family: var(--font-main);
        font-size: 0.9rem;
        display: none;
      "
    >
      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 10px;
        "
      >
        <h3 style="margin: 0; color: var(--color-text)">Graph Statistics</h3>
        <button
          id="close-stats"
          style="
            background: none;
            border: none;
            color: var(--color-text);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 0;
            width: 20px;
            height: 20px;
          "
        >
          ×
        </button>
      </div>
      <div id="stats-content">
        <div style="margin-bottom: 8px">
          <strong style="color: var(--color-text)">Edges:</strong>
        </div>
        <div style="margin-left: 15px; margin-bottom: 4px">
          • Inlusion Tree Edges: <span id="stat-tree-edges">0</span>
        </div>
        <div style="margin-left: 15px; margin-bottom: 4px">
          • Visible Edges: <span id="stat-visible-edges">0</span>
        </div>
        <div style="margin-left: 15px; margin-bottom: 8px">
          • Internal Cluster Edges: <span id="stat-internal-edges">0</span>
        </div>

        <div style="margin-bottom: 8px">
          <strong style="color: var(--color-text)">Clusters:</strong>
        </div>
        <div style="margin-left: 15px; margin-bottom: 8px">
          • Total Clusters: <span id="stat-total-clusters">0</span>
        </div>

        <div style="margin-bottom: 8px">
          <strong style="color: var(--color-text)">Leaves:</strong>
        </div>
        <div style="margin-left: 15px; margin-bottom: 4px">
          • Total Leaves: <span id="stat-total-leaves">0</span>
        </div>
      </div>
    </div>

    <script>
      // Function to handle all visualization downloads
      // Function to handle all visualization downloads
      function saveVisualization(format) {
        // Directly search for the SVG element on the page
        const svgElement = document.querySelector("svg");

        if (!svgElement) {
          alert(
            "No SVG visualization found to download. Please draw a graph first."
          );
          return;
        }

        // Continue with the rest of the original logic:
        const zoomGroup = svgElement.querySelector(".zoom-group");

        // Calculate the bounding box of the content for accurate export size
        const bbox = svgElement.getBBox();

        // --- TEMPORARY FIX SETUP ---
        // 1. Store original viewBox/width/height
        const originalViewBox = svgElement.getAttribute("viewBox");
        const originalWidth = svgElement.getAttribute("width");
        const originalHeight = svgElement.getAttribute("height");

        // Set explicit size attributes for reliable conversion and drawing
        svgElement.setAttribute("width", bbox.width);
        svgElement.setAttribute("height", bbox.height);
        svgElement.setAttribute(
          "viewBox",
          `${bbox.x} ${bbox.y} ${bbox.width} ${bbox.height}`
        );

        // 2. Store original zoom/pan transform
        const originalTransform = zoomGroup
          ? zoomGroup.getAttribute("transform")
          : null;

        // 3. RESET ZOOM/PAN to default view temporarily for export
        if (zoomGroup) {
          zoomGroup.setAttribute("transform", "translate(0,0)scale(1)");
        }

        // 4. FONT & COLOR FIX: Hardcode computed styles to resolve CSS variable issues
        const styledElements = svgElement.querySelectorAll(
          "text, rect, path, line, circle, ellipse, polygon, polyline"
        );
        const originalStyles = [];

        styledElements.forEach((el) => {
          const computedStyle = window.getComputedStyle(el);
          let stylesToRestore = {};

          const originalFillAttr = el.getAttribute("fill");
          const originalStrokeAttr = el.getAttribute("stroke");
          const originalFontFamilyAttr = el.getAttribute("font-family");

          const usesVarColor =
            (originalFillAttr && originalFillAttr.includes("var(")) ||
            (originalStrokeAttr && originalStrokeAttr.includes("var("));
          const usesVarFont =
            originalFontFamilyAttr && originalFontFamilyAttr.includes("var(");

          if (!usesVarColor && !usesVarFont) {
            return;
          }

          // Color Forcing
          const finalFill = computedStyle.fill;
          if (
            usesVarColor &&
            finalFill &&
            finalFill !== "none" &&
            finalFill !== "transparent"
          ) {
            stylesToRestore.fill = originalFillAttr;
            el.setAttribute("fill", finalFill);
          }

          const finalStroke = computedStyle.stroke;
          if (
            usesVarColor &&
            finalStroke &&
            finalStroke !== "none" &&
            finalStroke !== "transparent"
          ) {
            stylesToRestore.stroke = originalStrokeAttr;
            el.setAttribute("stroke", finalStroke);
          }

          // Font Forcing (The original fix for the user's initial problem)
          if (el.tagName === "text" && usesVarFont) {
            const finalFontFamily = computedStyle.fontFamily;
            if (finalFontFamily) {
              stylesToRestore["font-family"] = originalFontFamilyAttr;
              el.setAttribute("font-family", finalFontFamily);
            }
          }

          if (Object.keys(stylesToRestore).length > 0) {
            originalStyles.push({ element: el, styles: stylesToRestore });
          }
        });

        // --- SERIALIZATION & BLOB CREATION ---
        let svgString = new XMLSerializer().serializeToString(svgElement);

        // CRITICAL FIX: Remove XML declaration to prevent canvas image loading errors for PNG/PDF.
        svgString = svgString.replace(/<\?xml[^>]*\?>/i, "");

        const blob = new Blob([svgString], {
          type: "image/svg+xml;charset=utf-8",
        });
        const url = URL.createObjectURL(blob);

        // --- CLEANUP FUNCTION ---
        const cleanup = () => {
          // 1. Restore zoom/pan
          if (zoomGroup && originalTransform) {
            zoomGroup.setAttribute("transform", originalTransform);
          }

          // 2. Restore colors and fonts
          originalStyles.forEach((item) => {
            if (item.element) {
              const el = item.element;
              const restore = (attr, value) => {
                if (value === null || value === undefined) {
                  el.removeAttribute(attr);
                } else {
                  el.setAttribute(attr, value);
                }
              };

              if (item.styles.fill !== undefined)
                restore("fill", item.styles.fill);
              if (item.styles.stroke !== undefined)
                restore("stroke", item.styles.stroke);
              if (item.styles["font-family"] !== undefined)
                restore("font-family", item.styles["font-family"]);
            }
          });

          // 3. Restore original SVG size attributes
          if (originalViewBox !== null) {
            svgElement.setAttribute("viewBox", originalViewBox);
          } else {
            svgElement.removeAttribute("viewBox");
          }
          if (originalWidth !== null) {
            svgElement.setAttribute("width", originalWidth);
          } else {
            svgElement.removeAttribute("width");
          }
          if (originalHeight !== null) {
            svgElement.setAttribute("height", originalHeight);
          } else {
            svgElement.removeAttribute("height");
          }

          URL.revokeObjectURL(url);
        };

        // --- DOWNLOAD LOGIC ---
        if (format === "svg") {
          const a = document.createElement("a");
          a.href = url;
          a.download = "visualization.svg";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          cleanup();
        } else if (format === "png" || format === "pdf") {
          const canvas = document.createElement("canvas");
          canvas.width = bbox.width;
          canvas.height = bbox.height;

          const ctx = canvas.getContext("2d");
          const img = new Image();

          img.onerror = function (error) {
            console.error("Error loading SVG for canvas conversion:", error);
            alert(
              "Error during image conversion. Please try downloading as SVG."
            );
            cleanup();
          };

          img.onload = function () {
            // Set canvas size
            canvas.width = bbox.width;
            canvas.height = bbox.height;

            // Set a white background explicitly before drawing the SVG
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw the SVG content onto the canvas (this layer will be drawn over the white background)
            ctx.drawImage(this, 0, 0);

            if (format === "png") {
              const pngUrl = canvas.toDataURL("image/png");
              const a = document.createElement("a");
              a.href = pngUrl;
              a.download = "visualization.png";
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              cleanup();
            } else if (format === "pdf") {
              // Requires the jsPDF library to be included in the HTML
              if (
                typeof window.jspdf === "undefined" ||
                typeof window.jspdf.jsPDF !== "function"
              ) {
                alert("PDF export failed. jsPDF library not found.");
                cleanup();
                return;
              }

              // Get image data from the canvas
              const imgData = canvas.toDataURL("image/jpeg", 1.0); // Use JPEG for smaller PDF size
              const pdf = new jspdf.jsPDF({
                orientation: "landscape", // or 'portrait'
                unit: "px",
                format: [canvas.width, canvas.height], // Set PDF size to canvas size
              });

              // Add the image to the PDF
              pdf.addImage(imgData, "JPEG", 0, 0, canvas.width, canvas.height);

              // Download the PDF
              pdf.save("visualization.pdf");
              cleanup();
            }
          };

          img.src = url;
        }
      }

      function solveAgain(selectedSolver, instanceId) {
        const urlParams = new URLSearchParams(window.location.search);
        const currentInstanceId = instanceId || urlParams.get("instance");
        const currentTheme = urlParams.get("theme");

        if (!currentInstanceId) {
          alert("No graph is currently loaded.");
          return;
        }

        // Update URL and reload with new solver
        let newUrl = `?instance=${currentInstanceId}&method=${selectedSolver}`;
        if (currentTheme) {
          newUrl += `&theme=${currentTheme}`;
        }
        window.location.href = newUrl;
      }

      window.showLoadingModal = function () {
        const loadingModal = document.getElementById("loading-modal");
        if (loadingModal) {
          loadingModal.style.display = "block";
        } else {
          console.error("Loading modal element not found.");
        }
      };

      window.hideLoadingModal = function () {
        const loadingModal = document.getElementById("loading-modal");
        if (loadingModal) {
          loadingModal.style.display = "none";
        }
      };

      // Function to update stats panel (called from drawer_d3.js)
      window.updateStatsPanel = function (stats) {
        document.getElementById("stat-tree-edges").textContent =
          stats.totalTreeEdges;
        document.getElementById("stat-visible-edges").textContent =
          stats.visibleEdges;
        document.getElementById("stat-internal-edges").textContent =
          stats.internalClusterEdges;
        document.getElementById("stat-total-clusters").textContent =
          stats.totalClusters;
        document.getElementById("stat-total-leaves").textContent =
          stats.totalLeaves;
      };

      document.addEventListener("DOMContentLoaded", () => {
        // Initialization MUST happen inside DOMContentLoaded to ensure elements exist.

        const urlParams = new URLSearchParams(window.location.search);
        const currentInstanceId = urlParams.get("instance") || "animals";
        let currentTheme = urlParams.get("theme"); // Use let as we may override it below

        let isK00lModeActive = false;

        const instanceIdInputHeader = document.getElementById(
          "instance-id-input-header"
        );

        // 1. EASTER EGG CLIENT-SIDE CHECK (Theme Activation)
        if (
          currentTheme === "k00l90z" ||
          (currentInstanceId && currentInstanceId.toLowerCase() === "k00l90z")
        ) {
          document.body.classList.add("k00l90z-mode");
          isK00lModeActive = true;
          currentTheme = "k00l90z"; // Ensure currentTheme is correctly set
        }

        // 2. Initialization of dell'Input Field from URL
        if (instanceIdInputHeader && currentInstanceId) {
          if (currentInstanceId.toLowerCase() === "k00l90z") {
            instanceIdInputHeader.value = "K00L 90Z MODE";
          } else {
            instanceIdInputHeader.value = currentInstanceId;
          }
        }

        // Zoom Controls - NEW
        const zoomOutButton = document.getElementById("zoom-out-button");
        const zoomResetButton = document.getElementById("zoom-reset-button");
        const zoomInButton = document.getElementById("zoom-in-button");

        const uploadButton = document.getElementById("uploadButton");
        const fileInput = document.getElementById("fileInput");

        const goToInstanceButton = document.getElementById(
          "go-to-instance-button"
        );
        const sampleButton = document.getElementById("sample-button");
        const sampleDropdown = document.getElementById("sample-dropdown");
        const downloadButton = document.getElementById("downloadButton");

        // SOLVER DROPDOWN ELEMENTS
        const solverButton = document.getElementById("solver-button");
        const solverDropdown = document.getElementById("solver-dropdown");

        // Stats Panel Elements
        const statsToggleButton = document.getElementById(
          "stats-toggle-button"
        );
        const statsPanel = document.getElementById("stats-panel");
        const closeStatsButton = document.getElementById("close-stats");

        // Edge display mode toggle
        const edgeDisplayToggle = document.getElementById(
          "edge-display-toggle"
        );
        let edgeDisplayMode = "ratio";

        if (edgeDisplayToggle) {
          edgeDisplayToggle.addEventListener("change", () => {
            edgeDisplayMode = edgeDisplayToggle.checked ? "absolute" : "ratio";

            window.dispatchEvent(
              new CustomEvent("edgeDisplayModeChange", {
                detail: { mode: edgeDisplayMode },
              })
            );
          });
        }

        const saveVizButton = document.getElementById("saveVizButton");
        const saveVizDropdown = document.getElementById("save-viz-dropdown");

        // Modal Elements
        const modal = document.getElementById("custom-modal");
        const instanceIdInput = document.getElementById("instance-id-input");
        const goButton = document.getElementById("go-button");
        const stayButton = document.getElementById("stay-button");

        const loadingModal = document.getElementById("loading-modal");
        const returnButton = document.getElementById("return-button");

        // Stats Panel Functionality
        if (statsToggleButton && statsPanel) {
          statsToggleButton.addEventListener("click", () => {
            const isVisible = statsPanel.style.display === "block";
            statsPanel.style.display = isVisible ? "none" : "block";
          });
        }

        if (closeStatsButton && statsPanel) {
          closeStatsButton.addEventListener("click", () => {
            statsPanel.style.display = "none";
          });
        }

        // Function to signal the server to stop the running solver
        async function stopSolverProcess() {
          try {
            // Assuming a POST request to a dedicated endpoint to interrupt the process
            const response = await fetch("/api/stop-solver", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              // You might want to send the instance ID or session ID here
              body: JSON.stringify({ action: "interrupt" }),
            });

            if (response.ok) {
              console.log("Solver interruption signal sent successfully.");
            } else {
              console.error("Failed to signal solver interruption.");
            }
          } catch (error) {
            console.error(
              "Network error while trying to interrupt solver:",
              error
            );
          }
        }

        if (loadingModal && returnButton) {
          returnButton.addEventListener("click", () => {
            // 1. Signal the server to stop the ongoing solver
            stopSolverProcess();

            // 2. Hide the modal and return to the current visualization
            hideLoadingModal();
          });
        }

        // Zoom Controls Event Listeners
        if (zoomOutButton && zoomResetButton && zoomInButton) {
          zoomOutButton.addEventListener("click", () => {
            window.dispatchEvent(new CustomEvent("zoomOut"));
          });

          zoomResetButton.addEventListener("click", () => {
            window.dispatchEvent(new CustomEvent("zoomReset"));
          });

          zoomInButton.addEventListener("click", () => {
            window.dispatchEvent(new CustomEvent("zoomIn"));
          });
        }

        uploadButton.addEventListener("click", () => {
          fileInput.click();
        });

        if (saveVizButton && saveVizDropdown) {
          // Toggle visibility
          saveVizButton.addEventListener("click", (event) => {
            event.stopPropagation();
            const isVisible = saveVizDropdown.style.display === "block";
            saveVizDropdown.style.display = isVisible ? "none" : "block";
          });

          // Handle clicks on the format links
          saveVizDropdown.querySelectorAll("a").forEach((link) => {
            link.addEventListener("click", (event) => {
              event.preventDefault();

              const format = link.getAttribute("data-format");
              saveVisualization(format);

              // Hide the dropdown after selection
              saveVizDropdown.style.display = "none";
            });
          });

          // Hide the dropdown if the user clicks anywhere else on the page
          document.addEventListener("click", (event) => {
            if (
              !saveVizDropdown.contains(event.target) &&
              event.target !== saveVizButton
            ) {
              saveVizDropdown.style.display = "none";
            }
          });
        }

        fileInput.addEventListener("change", async () => {
          const file = fileInput.files[0];
          if (!file) return;

          const formData = new FormData();
          formData.append("file", file);

          try {
            const res = await fetch("/api/upload", {
              method: "POST",
              body: formData,
            });

            const data = await res.json();

            if (!res.ok || !data.success) {
              alert("Upload failed: " + (data.message || "Unknown error"));
            } else {
              const instanceId = data.filename.replace(".json", "");

              // If modal elements are still null, alert and stop.
              if (!modal || !instanceIdInput || !goButton || !stayButton) {
                alert(
                  "Configuration Error: The custom modal elements were not found in the HTML."
                );
                return;
              }

              // --- CUSTOM MODAL LOGIC ---

              // 1. Set the ID value and show the modal
              instanceIdInput.value = instanceId;
              modal.style.display = "block";

              // 2. Automatically select the text for quick Ctrl+C
              instanceIdInput.select();
              instanceIdInput.setSelectionRange(0, 99999); // For mobile compatibility

              // 3. Define button actions (using .onclick to ensure a fresh handler each time)

              // Go Button: Navigate to the new instance
              goButton.onclick = () => {
                const selectedSolver =
                  document.getElementById("solver-select").value;

                modal.style.display = "none";
                let newUrl = `?instance=${instanceId}`;

                // Use 'method' parameter
                if (selectedSolver.toLowerCase() === "input") {
                  newUrl += "&method=input";
                } else if (selectedSolver.toLowerCase() === "ilp") {
                  newUrl += "&method=ilp";
                } else if (selectedSolver.toLowerCase() === "heuristic") {
                  newUrl += "&method=heuristic";
                } else if (selectedSolver.toLowerCase() === "hybrid") {
                  newUrl += "&method=hybrid";
                } else newUrl += "&method=input";

                // Keep the 90s theme if active
                if (isK00lModeActive) {
                  newUrl += "&theme=k00l90z";
                }

                window.location.href = newUrl;
              };

              // Stay Button: Close the modal and stay on the current page
              stayButton.onclick = () => {
                modal.style.display = "none";
              };

              // --- END CUSTOM MODAL LOGIC ---
            }
          } catch (err) {
            alert("Network or server error: " + err.message);
          }

          // Reset input, falls gleiche Datei nochmal gewählt wird
          fileInput.value = "";
        });

        if (downloadButton) {
          // This logic handles activation/deactivation and download link setting

          // We MUST use the CSS variable here, not the hardcoded attribute
          const activeColor = getComputedStyle(document.documentElement)
            .getPropertyValue("--color-primary")
            .trim();

          if (
            currentInstanceId &&
            currentInstanceId.toLowerCase() !== "k00l90z"
          ) {
            // 1. Visually activate the button
            downloadButton.style.opacity = 1;
            downloadButton.style.cursor = "pointer";
            downloadButton.removeAttribute("title");

            // 2. Set the download handler
            downloadButton.addEventListener("click", () => {
              const downloadUrl = `/api/download/${currentInstanceId}.json`;
              // Trigger the download
              window.open(downloadUrl, "_blank");
            });
          } else {
            // Ensure the button is fully disabled if no instance is loaded OR if k00l90z mode is active
            downloadButton.style.opacity = 0.5;
            downloadButton.style.cursor = "not-allowed";
            // Restore disabled color using the variable
            const disabledColor = getComputedStyle(document.documentElement)
              .getPropertyValue("--color-button-disabled")
              .trim();
            downloadButton.style.background = disabledColor;
            downloadButton.setAttribute(
              "title",
              "Load an instance first to enable download."
            );

            // Remove any previous event listeners (optional, but clean)
            downloadButton.onclick = null;
          }
        }

        // --- Sample Dropdown Toggle & Population ---
        if (sampleButton && sampleDropdown && instanceIdInputHeader) {
          // Toggle visibility
          sampleButton.addEventListener("click", (event) => {
            event.stopPropagation();
            const isVisible = sampleDropdown.style.display === "block";
            sampleDropdown.style.display = isVisible ? "none" : "block";
          });

          // Handle clicks on the sample links
          sampleDropdown.querySelectorAll("a").forEach((link) => {
            link.addEventListener("click", (event) => {
              event.preventDefault(); // <-- IMPORTANT: Stop navigation

              const instanceId = link.getAttribute("data-instance");

              // 1. Put the text in the textbox
              instanceIdInputHeader.value = instanceId;

              // 2. Hide the dropdown
              sampleDropdown.style.display = "none";

              // Optional: Focus the "Go" button for quick selection
              goToInstanceButton.focus();
            });
          });

          // Hide the dropdown if the user clicks anywhere else on the page
          document.addEventListener("click", (event) => {
            if (
              !sampleDropdown.contains(event.target) &&
              event.target !== sampleButton
            ) {
              sampleDropdown.style.display = "none";
            }
          });
        }

        // --- Solver Dropdown Toggle & Selection ---
        if (solverButton && solverDropdown) {
          const currentSolver = urlParams.get("method") || "input";
          let selectedSolver = currentSolver;

          // 1. Initilization
          let buttonText;
          const currentSolverInUrl = urlParams.get("method");

          if (!currentSolverInUrl) {
            // FIX: If no solver is in the URL, set the display text to "Change Order"
            buttonText = "Change Order";
          } else {
            // If a solver is in the URL, format it
            if (selectedSolver === "input") {
              buttonText = "Input Order";
            } else {
              const formattedSolver =
                selectedSolver.slice(0) === "ilp"
                  ? "ILP"
                  : selectedSolver.slice(0).charAt(0).toUpperCase() +
                    selectedSolver.slice(1).toLowerCase();
              buttonText = `${formattedSolver} Solver`;
            }
          }

          // Update the button HTML
          solverButton.innerHTML = `${buttonText} <span style="font-size: 0.7em;">&#x25BC;</span>`;

          // Toggle visibility
          solverButton.addEventListener("click", (event) => {
            event.stopPropagation();
            const isVisible = solverDropdown.style.display === "block";
            solverDropdown.style.display = isVisible ? "none" : "block";
          });

          // Handle clicks on the solver links
          solverDropdown.querySelectorAll("a").forEach((link) => {
            link.addEventListener("click", (event) => {
              event.preventDefault();

              const solver = link.getAttribute("data-solver");
              selectedSolver = solver;

              // 2. Updates the text of the button after selection
              let buttonText;
              if (selectedSolver === "input") {
                buttonText = "Input Order";
              } else {
                const formattedSolver =
                  selectedSolver.charAt(0).toUpperCase() +
                  selectedSolver.slice(1);
                buttonText = `${formattedSolver} Solver`;
              }

              solverButton.innerHTML = `${buttonText} <span style="font-size: 0.7em;">&#x25BC;</span>`;

              // Hide the dropdown
              solverDropdown.style.display = "none";
            });
          });

          // Hide the dropdown if the user clicks anywhere else on the page
          document.addEventListener("click", (event) => {
            if (
              !solverDropdown.contains(event.target) &&
              event.target !== solverButton
            ) {
              solverDropdown.style.display = "none";
            }
          });

          // --- Single Go Button that handles both functions ---
          if (goToInstanceButton && instanceIdInputHeader) {
            goToInstanceButton.addEventListener("click", () => {
              const instanceId = instanceIdInputHeader.value.trim();

              // If the user attempts to 'Go' to k00l90z, only apply the theme to the current page/instance
              if (instanceId.toLowerCase() === "k00l90z") {
                // Get the real current instance ID from the URL, or empty string if none is loaded.
                const realInstance = urlParams.get("instance") || "";

                if (loadingModal) {
                  loadingModal.style.display = "block";
                }

                // Reload the page with the current instance and the new theme parameter
                window.location.href = `?instance=${realInstance}&theme=k00l90z`;
                return; // Stop here
              }

              if (instanceId) {
                let newUrl = `?instance=${instanceId}&method=${selectedSolver}`;
                if (isK00lModeActive) {
                  newUrl += "&theme=k00l90z";
                }
                window.location.href = newUrl;
                return;
              }

              // If neither condition is met, show an alert
              alert("Please enter a valid Instance ID.");
            });
          }
        }

        if (loadingModal && returnButton) {
          returnButton.addEventListener("click", () => {
            // Simply hide the modal and stay on the current page.
            loadingModal.style.display = "none";
          });
        }

        // Expose the current theme to the module script
        window.currentAppTheme = currentTheme;

        // --- LABEL SIZE SLIDER ---
        const labelSizeSlider = document.getElementById("label-size-slider");
        const labelSizeValue = document.getElementById("label-size-value");

        // default size
        window.currentLabelSize = parseInt(labelSizeSlider.value, 10);

        if (labelSizeSlider && labelSizeValue) {
          labelSizeSlider.addEventListener("input", () => {
            const newSize = parseInt(labelSizeSlider.value, 10);
            labelSizeValue.textContent = `${newSize}px`;
            window.currentLabelSize = newSize;

            // Dispatch event so drawer can react dynamically
            window.dispatchEvent(
              new CustomEvent("labelSizeChange", { detail: { size: newSize } })
            );
          });
        }
      }); // <-- End of DOMContentLoaded listener
    </script>

    <div
      id="custom-modal"
      style="
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.6);
      "
    >
      <div
        class="modal-content-container"
        style="
          margin: 15% auto;
          padding: 20px;
          border: 1px solid #555;
          width: 80%;
          max-width: 400px;
          border-radius: 8px;
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
        "
      >
        <h2 style="margin-top: 0">Success!</h2>
        <p style="margin-bottom: 20px">Your new graph instance is ready.</p>

        <input
          type="text"
          id="instance-id-input"
          value=""
          readonly
          style="
            width: 95%;
            padding: 10px;
            margin-bottom: 20px;
            font-weight: bold;
            font-family: monospace;
            border-radius: 4px;
          "
        />
        <div style="margin-bottom: 10px">
          <label for="solver-select" style="display: block; margin-bottom: 5px"
            >Input Order:</label
          >
          <select
            id="solver-select"
            style="
              width: 100%;
              padding: 8px;
              border-radius: 5px;
              border: 1px solid #ccc;
              font-family: var(--font-main);
              background-color: var(--color-background-medium);
              color: var(--color-text-input);
            "
          >
            <option value="input" selected>Input Order</option>
            <option value="ilp">ILP Solver</option>
            <option value="heuristic">Heuristic Solver</option>
            <option value="hybrid">Hybrid Solver</option>
          </select>
        </div>

        <div style="display: flex; justify-content: space-between">
          <button
            id="stay-button"
            style="
              padding: 10px 15px;
              border: none;
              border-radius: 5px;
              cursor: pointer;
              transition: background-color 0.2s;
            "
          >
            Cancel
          </button>

          <button
            id="go-button"
            style="
              padding: 10px 15px;
              border: none;
              border-radius: 5px;
              cursor: pointer;
              font-weight: bold;
              transition: background-color 0.2s;
            "
          >
            Go to New Instance
          </button>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const toggleButton = document.getElementById(
          "control-panel-toggle-button"
        );
        const controlPanel = document.getElementById("control-panel");

        if (toggleButton && controlPanel) {
          toggleButton.addEventListener("click", () => {
            // Determine if the panel is currently visible
            const isVisible = controlPanel.style.display === "block";

            // 1. Toggle the display property
            controlPanel.style.display = isVisible ? "none" : "block";

            // 2. Redraw the legend only when the panel is being shown
            if (!isVisible) {
              // Check if the global drawer object exists and the method is callable
              if (
                window.HCGDrawer &&
                typeof window.HCGDrawer.drawEdgeColorLegend === "function"
              ) {
                // This forces D3 to measure the now-visible container and redraw
                window.HCGDrawer.drawEdgeColorLegend();
                if (
                  typeof window.HCGDrawer.drawAdjCellColorLegend === "function"
                ) {
                  window.HCGDrawer.drawAdjCellColorLegend();
                }
                if (typeof window.HCGDrawer.drawDirectedLegend === "function") {
                  window.HCGDrawer.drawDirectedLegend();
                }
              }
            }

            // Optional: Update button text to reflect the current state
            toggleButton.textContent = isVisible
              ? "Show drawing styles"
              : "Hide drawing styles";
          });
        }
      });
    </script>
  </body>
</html>
