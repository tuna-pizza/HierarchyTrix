<!DOCTYPE html>
<html lang="en">
  <head>
    <title>HierarchyTrix</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link
      href="https://fonts.googleapis.com/css2?family=VT323&display=swap"
      rel="stylesheet"
    />

    <style>
      /* --- 1. DEFINE DEFAULT VARIABLES --- */
      :root {
        --color-primary: #4caf50; /* Green (Upload/Go) */
        --color-secondary: hsl(210, 60%, 49%); /* Blue (Instance/Sample) */
        --color-tertiary: #ffd700; /* Yellow (Save Viz) */
        --color-background-dark: #222;
        --color-background-medium: #333;
        --color-text-header: white;
        --color-text-input: white;
        --color-text-button: white; /* Consistent button text color */
        --color-button-disabled: #555;
        --font-main: sans-serif;
      }

      /* --- 2. 90s THEME VARIABLES (Override) --- */
      .k00l90z-mode {
        /* 90s K00L Font: Monospace/Pixelated look */
        --font-main: "VT323", monospace;

        /* High-Contrast, Neon/Vaporwave Colors */
        --color-primary: #00ffff; /* Aqua/Cyan */
        --color-secondary: #ff00ff; /* Magenta/Fuchsia */
        --color-tertiary: #ff00ff;
        --color-background-dark: #111133; /* Dark Blue/Purple */
        --color-background-medium: #222255;
        --color-text-header: #ffd700; /* Gold/Bright Yellow */
        --color-text-input: #00ffff;
        --color-text-button: #111133; /* Dark text on neon buttons */
        --color-button-disabled: #00ffff;
      }

      /* Apply 90s Font to body */
      .k00l90z-mode,
      .k00l90z-mode body {
        font-family: var(--font-main) !important;
        background-color: var(--color-background-dark);
        color: var(--color-text-header);
      }

      /* --- 3. APPLY VARIABLES TO ELEMENTS --- */
      header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: var(--color-background-dark);
        color: var(--color-text-header);
        padding: 10px 20px;
        font-family: var(--font-main);
      }
      h1 {
        margin: 0;
        font-size: 1.2rem;
      }

      /* Zoom Buttons */
      #zoom-controls {
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .zoom-button {
        background: var(--color-background-medium);
        border: 1px solid var(--color-secondary);
        color: var(--color-text-header);
        padding: 6px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-family: var(--font-main);
        font-size: 0.9rem;
        min-width: 40px;
      }
      .zoom-button:hover {
        background: var(--color-secondary);
        color: var(--color-text-button);
      }

      #uploadButton {
        background: var(--color-secondary);
        border: none;
        color: var(--color-text-button);
        padding: 8px 14px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        font-family: var(--font-main);
      }
      #uploadButton:hover,
      #downloadButton:hover {
        /* Keep a slight darker shade for hover in default mode */
        background: var(--color-secondary);
        filter: brightness(80%);
      }

      /* Instance Input Styling */
      #instance-id-input-header {
        padding: 6px;
        border: 1px solid var(--color-secondary);
        background: var(--color-background-medium);
        color: var(--color-text-input);
        border-radius: 4px;
        width: 120px;
        font-size: 0.9rem;
        font-family: var(--font-main);
      }

      /* Instance Buttons (Go & Sample & Solver) */
      #sample-button,
      #go-to-instance-button,
      #solver-button {
        background: var(--color-secondary);
        border: none;
        color: var(--color-text-button);
        padding: 8px 10px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        font-size: 0.9rem;
        font-family: var(--font-main);
      }
      #sample-button:hover,
      #go-to-instance-button:hover,
      #solver-button:hover {
        /* Apply a slight darkening effect on hover */
        background: var(--color-secondary);
        filter: brightness(80%);
      }

      /* Dropdown Styles */
      #sample-dropdown,
      #solver-dropdown {
        width: 130px;
        background-color: var(--color-background-medium);
        border: 1px solid var(--color-secondary);
      }
      #sample-dropdown a,
      #solver-dropdown a {
        color: var(--color-text-header);
        font-family: var(--font-main);
      }

      /* Save Viz Button */
      #saveVizButton {
        background: var(--color-secondary);
        border: none;
        color: var(--color-text-button);
        padding: 8px 14px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        font-family: var(--font-main);
      }
      #saveVizButton:hover {
        /* Keep a slight darker shade for hover in default mode */
        background: var(--color-secondary);
        filter: brightness(80%);
      }
      #save-viz-dropdown {
        background-color: var(--color-background-medium);
        border: 1px solid var(--color-secondary);
      }
      #save-viz-dropdown a {
        color: var(--color-text-header);
        font-family: var(--font-main);
      }

      /* Download Button */
      #downloadButton {
        border: none;
        background-color: var(--color-secondary);
        color: var(--color-text-header);
        padding: 8px 14px;
        border-radius: 6px;
        cursor: not-allowed;
        font-weight: bold;
        font-family: var(--font-main);
        opacity: 0.5; /* Always start disabled visually */
      }

      .k00l90z-mode .modal-content-container {
        /* Use sharp corners for the 90s look */
        border-radius: 0 !important;
        /* Create a neon glow effect using multiple shadows */
        box-shadow: 0 0 8px var(--color-secondary),
          0 0 15px var(--color-secondary), 0 0 25px #ff00ff !important;
        /* Thicker border using the secondary neon color */
        border: 2px solid var(--color-secondary) !important;
      }

      .k00l90z-mode #instance-id-input {
        /* Sharp corners for the ID input field */
        border-radius: 0 !important;
        /* Optional: Add a subtle inner shadow for a screen look */
        box-shadow: inset 0 0 5px rgba(0, 255, 255, 0.5);
      }

      .k00l90z-mode #custom-modal h2 {
        /* Ensure the checkmark and text are bright neon */
        color: var(--color-primary);
        text-shadow: 0 0 5px var(--color-primary);
      }

      /* Modal Styles */
      #custom-modal .modal-content-container {
        background-color: var(--color-background-medium);
        color: var(--color-text-header);
        border: 1px solid var(--color-secondary);
        font-family: var(--font-main);
      }
      #custom-modal h2 {
        color: var(--color-primary);
      }
      #instance-id-input {
        border: 1px solid var(--color-primary);
        background-color: var(--color-background-dark);
        color: var(--color-text-input);
        font-family: var(--font-main);
      }
      #stay-button {
        background-color: var(--color-button-disabled);
        color: var(--color-text-button);
        font-family: var(--font-main);
      }
      #go-button {
        background-color: var(--color-primary);
        color: var(--color-text-button);
        font-family: var(--font-main);
      }
      body {
        /* Default Theme Colors */
        --node-color: black;
        --cell-boundary-color: #888b90;
        --tree-color: #dadbdd;
        --edge-color: hsl(210, 60%, 49%);
        --adj-color-low: hsl(210, 60%, 90%); /* Light default blue */
        --adj-color-high: hsl(210, 60%, 49%);
      }

      /* K00L90Z Theme Overrides */
      body.k00l90z-mode {
        --node-color: #ff00ff; /* Magenta nodes */
        --cell-boundary-color: #00ffff; /* Cyan boundaries */
        --tree-color: yellow; /* Magenta cluster bands */
        --edge-color: #00ffff; /* Cyan edges */
        --adj-color-low: hsl(300, 80%, 95%); /* Light 90s purple */
        --adj-color-high: hsl(300, 80%, 55%); /* Dark 90s purple */
      }

      /* Optional: Darken text in k00l90z mode for better contrast against bright nodes */
      body.k00l90z-mode text {
        fill: #000 !important;
      }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script type="module" src="js/client.js" defer></script>
  </head>
  <body>
    <header id="main-header-container">
      <h1>HierarchyTrix</h1>
      <div style="display: flex; gap: 15px; align-items: center">
        <!-- Zoom Controls - ADDED BEFORE UPLOAD BUTTON -->
        <div id="zoom-controls">
          <button id="zoom-out-button" class="zoom-button" title="Zoom Out">
            -
          </button>
          <button id="zoom-reset-button" class="zoom-button" title="Reset Zoom">
            100%
          </button>
          <button id="zoom-in-button" class="zoom-button" title="Zoom In">
            +
          </button>
        </div>

        <button id="uploadButton">Upload JSON</button>
        <input
          type="file"
          id="fileInput"
          accept=".json"
          style="display: none"
        />

        <div
          id="instance-selector"
          style="
            display: flex;
            align-items: center;
            gap: 5px;
            position: relative;
          "
        >
          <input
            type="text"
            id="instance-id-input-header"
            placeholder="Instance ID"
            style=""
          />

          <div id="samples-popover-container" style="position: relative">
            <button id="sample-button" title="Select a sample ID" style="">
              Instance <span style="font-size: 0.7em">&#x25BC;</span>
            </button>

            <div
              id="sample-dropdown"
              style="
                display: none;
                position: absolute;
                top: 100%;
                left: -126px;
                width: 175px;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
                z-index: 200;
              "
            >
              <a
                data-instance="sample"
                href="#"
                style="
                  padding: 8px 10px;
                  text-decoration: none;
                  display: block;
                  font-size: 0.9rem;
                "
                >sample</a
              >
              <a
                data-instance="paper_example"
                href="#"
                style="
                  padding: 8px 10px;
                  text-decoration: none;
                  display: block;
                  font-size: 0.9rem;
                "
                >paper_example</a
              >
              <a
                data-instance="graph_1"
                href="#"
                style="
                  padding: 8px 10px;
                  text-decoration: none;
                  display: block;
                  font-size: 0.9rem;
                "
                >graph_1</a
              >
              <a
                data-instance="graph_2"
                href="#"
                style="
                  padding: 8px 10px;
                  text-decoration: none;
                  display: block;
                  font-size: 0.9rem;
                "
                >graph_2</a
              >
              <a
                data-instance="graph_3"
                href="#"
                style="
                  padding: 8px 10px;
                  text-decoration: none;
                  display: block;
                  font-size: 0.9rem;
                "
                >graph_3</a
              >
            </div>
          </div>

          <div id="solver-popover-container" style="position: relative">
            <button id="solver-button" title="Select solver method" style="">
              Solver <span style="font-size: 0.7em">&#x25BC;</span>
            </button>

            <div
              id="solver-dropdown"
              style="
                display: none;
                position: absolute;
                top: 100%;
                left: 0;
                width: 120px;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
                z-index: 200;
              "
            >
              <a
                data-solver="ilp"
                href="#"
                style="
                  padding: 8px 10px;
                  text-decoration: none;
                  display: block;
                  font-size: 0.9rem;
                "
                >ILP Solver</a
              >
              <a
                data-solver="heuristic"
                href="#"
                style="
                  padding: 8px 10px;
                  text-decoration: none;
                  display: block;
                  font-size: 0.9rem;
                "
                >Heuristic Solver</a
              >
              <a
                data-solver="hybrid"
                href="#"
                style="
                  padding: 8px 10px;
                  text-decoration: none;
                  display: block;
                  font-size: 0.9rem;
                "
                >Hybrid Solver</a
              >
            </div>
          </div>

          <button id="go-to-instance-button" style="">Go</button>
        </div>

        <div id="save-viz-container" style="position: relative">
          <button
            id="saveVizButton"
            title="Save current visualization"
            style=""
          >
            Save Visualization
          </button>

          <div
            id="save-viz-dropdown"
            style="
              display: none;
              position: absolute;
              top: 100%;
              right: 0;
              min-width: 150px;
              box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
              z-index: 200;
            "
          >
            <a
              data-format="svg"
              href="#"
              style="
                padding: 8px 10px;
                text-decoration: none;
                display: block;
                font-size: 0.9rem;
              "
              >Save as SVG</a
            >
            <a
              data-format="png"
              href="#"
              style="
                padding: 8px 10px;
                text-decoration: none;
                display: block;
                font-size: 0.9rem;
              "
              >Save as PNG</a
            >
            <a
              data-format="pdf"
              href="#"
              style="
                padding: 8px 10px;
                text-decoration: none;
                display: block;
                font-size: 0.9rem;
              "
              >Save as PDF</a
            >
          </div>
        </div>

        <button id="downloadButton" style="">Download JSON</button>
      </div>
    </header>

    <script>
      // Function to handle all visualization downloads
      // Function to handle all visualization downloads
      function saveVisualization(format) {
        // FIX: Directly search for the SVG element on the page
        const svgElement = document.querySelector("svg");

        if (!svgElement) {
          alert(
            "No SVG visualization found to download. Please draw a graph first."
          );
          return;
        }

        // Continue with the rest of the original logic:
        const zoomGroup = svgElement.querySelector(".zoom-group");

        // Calculate the bounding box of the content for accurate export size
        const bbox = svgElement.getBBox();

        // --- TEMPORARY FIX SETUP ---
        // 1. Store original viewBox/width/height
        const originalViewBox = svgElement.getAttribute("viewBox");
        const originalWidth = svgElement.getAttribute("width");
        const originalHeight = svgElement.getAttribute("height");

        // Set explicit size attributes for reliable conversion and drawing
        svgElement.setAttribute("width", bbox.width);
        svgElement.setAttribute("height", bbox.height);
        svgElement.setAttribute(
          "viewBox",
          `${bbox.x} ${bbox.y} ${bbox.width} ${bbox.height}`
        );

        // 2. Store original zoom/pan transform
        const originalTransform = zoomGroup
          ? zoomGroup.getAttribute("transform")
          : null;

        // 3. RESET ZOOM/PAN to default view temporarily for export
        if (zoomGroup) {
          zoomGroup.setAttribute("transform", "translate(0,0)scale(1)");
        }

        // 4. FONT & COLOR FIX: Hardcode computed styles to resolve CSS variable issues
        const styledElements = svgElement.querySelectorAll(
          "text, rect, path, line, circle, ellipse, polygon, polyline"
        );
        const originalStyles = [];

        styledElements.forEach((el) => {
          const computedStyle = window.getComputedStyle(el);
          let stylesToRestore = {};

          const originalFillAttr = el.getAttribute("fill");
          const originalStrokeAttr = el.getAttribute("stroke");
          const originalFontFamilyAttr = el.getAttribute("font-family");

          const usesVarColor =
            (originalFillAttr && originalFillAttr.includes("var(")) ||
            (originalStrokeAttr && originalStrokeAttr.includes("var("));
          const usesVarFont =
            originalFontFamilyAttr && originalFontFamilyAttr.includes("var(");

          if (!usesVarColor && !usesVarFont) {
            return;
          }

          // Color Forcing
          const finalFill = computedStyle.fill;
          if (
            usesVarColor &&
            finalFill &&
            finalFill !== "none" &&
            finalFill !== "transparent"
          ) {
            stylesToRestore.fill = originalFillAttr;
            el.setAttribute("fill", finalFill);
          }

          const finalStroke = computedStyle.stroke;
          if (
            usesVarColor &&
            finalStroke &&
            finalStroke !== "none" &&
            finalStroke !== "transparent"
          ) {
            stylesToRestore.stroke = originalStrokeAttr;
            el.setAttribute("stroke", finalStroke);
          }

          // Font Forcing (The original fix for the user's initial problem)
          if (el.tagName === "text" && usesVarFont) {
            const finalFontFamily = computedStyle.fontFamily;
            if (finalFontFamily) {
              stylesToRestore["font-family"] = originalFontFamilyAttr;
              el.setAttribute("font-family", finalFontFamily);
            }
          }

          if (Object.keys(stylesToRestore).length > 0) {
            originalStyles.push({ element: el, styles: stylesToRestore });
          }
        });

        // --- SERIALIZATION & BLOB CREATION ---
        let svgString = new XMLSerializer().serializeToString(svgElement);

        // CRITICAL FIX: Remove XML declaration to prevent canvas image loading errors for PNG/PDF.
        svgString = svgString.replace(/<\?xml[^>]*\?>/i, "");

        const blob = new Blob([svgString], {
          type: "image/svg+xml;charset=utf-8",
        });
        const url = URL.createObjectURL(blob);

        // --- CLEANUP FUNCTION ---
        const cleanup = () => {
          // 1. Restore zoom/pan
          if (zoomGroup && originalTransform) {
            zoomGroup.setAttribute("transform", originalTransform);
          }

          // 2. Restore colors and fonts
          originalStyles.forEach((item) => {
            if (item.element) {
              const el = item.element;
              const restore = (attr, value) => {
                if (value === null || value === undefined) {
                  el.removeAttribute(attr);
                } else {
                  el.setAttribute(attr, value);
                }
              };

              if (item.styles.fill !== undefined)
                restore("fill", item.styles.fill);
              if (item.styles.stroke !== undefined)
                restore("stroke", item.styles.stroke);
              if (item.styles["font-family"] !== undefined)
                restore("font-family", item.styles["font-family"]);
            }
          });

          // 3. Restore original SVG size attributes
          if (originalViewBox !== null) {
            svgElement.setAttribute("viewBox", originalViewBox);
          } else {
            svgElement.removeAttribute("viewBox");
          }
          if (originalWidth !== null) {
            svgElement.setAttribute("width", originalWidth);
          } else {
            svgElement.removeAttribute("width");
          }
          if (originalHeight !== null) {
            svgElement.setAttribute("height", originalHeight);
          } else {
            svgElement.removeAttribute("height");
          }

          URL.revokeObjectURL(url);
        };

        // --- DOWNLOAD LOGIC ---
        if (format === "svg") {
          const a = document.createElement("a");
          a.href = url;
          a.download = "visualization.svg";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          cleanup();
        } else if (format === "png" || format === "pdf") {
          const canvas = document.createElement("canvas");
          canvas.width = bbox.width;
          canvas.height = bbox.height;

          const ctx = canvas.getContext("2d");
          const img = new Image();

          img.onerror = function (error) {
            console.error("Error loading SVG for canvas conversion:", error);
            alert(
              "Error during image conversion. Please try downloading as SVG."
            );
            cleanup();
          };

          img.onload = function () {
            // Set canvas size
            canvas.width = bbox.width;
            canvas.height = bbox.height;

            // Set a white background explicitly before drawing the SVG
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw the SVG content onto the canvas (this layer will be drawn over the white background)
            ctx.drawImage(this, 0, 0);

            if (format === "png") {
              const pngUrl = canvas.toDataURL("image/png");
              const a = document.createElement("a");
              a.href = pngUrl;
              a.download = "visualization.png";
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              cleanup();
            } else if (format === "pdf") {
              // Requires the jsPDF library to be included in the HTML
              if (
                typeof window.jspdf === "undefined" ||
                typeof window.jspdf.jsPDF !== "function"
              ) {
                alert("PDF export failed. jsPDF library not found.");
                cleanup();
                return;
              }

              // Get image data from the canvas
              const imgData = canvas.toDataURL("image/jpeg", 1.0); // Use JPEG for smaller PDF size
              const pdf = new jspdf.jsPDF({
                orientation: "landscape", // or 'portrait'
                unit: "px",
                format: [canvas.width, canvas.height], // Set PDF size to canvas size
              });

              // Add the image to the PDF
              pdf.addImage(imgData, "JPEG", 0, 0, canvas.width, canvas.height);

              // Download the PDF
              pdf.save("visualization.pdf");
              cleanup();
            }
          };

          img.src = url;
        }
      }

      // Function to trigger solve again
      function solveAgain(selectedSolver) {
        const urlParams = new URLSearchParams(window.location.search);
        const currentInstanceId = urlParams.get("instance");
        const currentTheme = urlParams.get("theme");

        if (!currentInstanceId) {
          alert("No graph is currently loaded.");
          return;
        }

        // Update URL and reload with new solver
        let newUrl = `?instance=${currentInstanceId}&method=${selectedSolver}`;
        if (currentTheme) {
          newUrl += `&theme=${currentTheme}`;
        }
        window.location.href = newUrl;
      }

      document.addEventListener("DOMContentLoaded", () => {
        // Initialization MUST happen inside DOMContentLoaded to ensure elements exist.

        const urlParams = new URLSearchParams(window.location.search);
        const currentInstanceId = urlParams.get("instance");
        let currentTheme = urlParams.get("theme"); // Use let as we may override it below

        let isK00lModeActive = false;

        // NEW/CORRECTED LOCATION: Define the instance input element right away.
        const instanceIdInputHeader = document.getElementById(
          "instance-id-input-header"
        );

        // 1. EASTER EGG CLIENT-SIDE CHECK (Theme Activation)
        if (
          currentTheme === "k00l90z" ||
          (currentInstanceId && currentInstanceId.toLowerCase() === "k00l90z")
        ) {
          document.body.classList.add("k00l90z-mode");
          isK00lModeActive = true;
          currentTheme = "k00l90z"; // Ensure currentTheme is correctly set
        }

        // 2. Initialization of dell'Input Field from URL
        if (instanceIdInputHeader && currentInstanceId) {
          if (currentInstanceId.toLowerCase() === "k00l90z") {
            instanceIdInputHeader.value = "K00L 90Z MODE";
          } else {
            instanceIdInputHeader.value = currentInstanceId;
          }
        }

        // Zoom Controls - NEW
        const zoomOutButton = document.getElementById("zoom-out-button");
        const zoomResetButton = document.getElementById("zoom-reset-button");
        const zoomInButton = document.getElementById("zoom-in-button");

        const uploadButton = document.getElementById("uploadButton");
        const fileInput = document.getElementById("fileInput");

        const goToInstanceButton = document.getElementById(
          "go-to-instance-button"
        );
        const sampleButton = document.getElementById("sample-button");
        const sampleDropdown = document.getElementById("sample-dropdown");
        const downloadButton = document.getElementById("downloadButton");

        // SOLVER DROPDOWN ELEMENTS
        const solverButton = document.getElementById("solver-button");
        const solverDropdown = document.getElementById("solver-dropdown");

        const saveVizButton = document.getElementById("saveVizButton");
        const saveVizDropdown = document.getElementById("save-viz-dropdown");

        // Modal Elements
        const modal = document.getElementById("custom-modal");
        const instanceIdInput = document.getElementById("instance-id-input");
        const goButton = document.getElementById("go-button");
        const stayButton = document.getElementById("stay-button");

        // Check for critical null elements just in case the HTML structure is missing
        if (!uploadButton || !fileInput) {
          console.error("Critical upload UI elements missing!");
          return;
        }

        // Zoom Controls Event Listeners
        if (zoomOutButton && zoomResetButton && zoomInButton) {
          zoomOutButton.addEventListener("click", () => {
            window.dispatchEvent(new CustomEvent("zoomOut"));
          });

          zoomResetButton.addEventListener("click", () => {
            window.dispatchEvent(new CustomEvent("zoomReset"));
          });

          zoomInButton.addEventListener("click", () => {
            window.dispatchEvent(new CustomEvent("zoomIn"));
          });
        }

        uploadButton.addEventListener("click", () => {
          fileInput.click();
        });

        if (saveVizButton && saveVizDropdown) {
          // Toggle visibility
          saveVizButton.addEventListener("click", (event) => {
            event.stopPropagation();
            const isVisible = saveVizDropdown.style.display === "block";
            saveVizDropdown.style.display = isVisible ? "none" : "block";
          });

          // Handle clicks on the format links
          saveVizDropdown.querySelectorAll("a").forEach((link) => {
            link.addEventListener("click", (event) => {
              event.preventDefault();

              const format = link.getAttribute("data-format");
              saveVisualization(format);

              // Hide the dropdown after selection
              saveVizDropdown.style.display = "none";
            });
          });

          // Hide the dropdown if the user clicks anywhere else on the page
          document.addEventListener("click", (event) => {
            if (
              !saveVizDropdown.contains(event.target) &&
              event.target !== saveVizButton
            ) {
              saveVizDropdown.style.display = "none";
            }
          });
        }

        fileInput.addEventListener("change", async () => {
          const file = fileInput.files[0];
          if (!file) return;

          const formData = new FormData();
          formData.append("file", file);

          try {
            const res = await fetch("/api/upload", {
              method: "POST",
              body: formData,
            });

            const data = await res.json();

            if (!res.ok || !data.success) {
              alert("❌ Upload failed: " + (data.message || "Unknown error"));
            } else {
              const instanceId = data.filename.replace(".json", "");

              // CRITICAL CHECK: If modal elements are still null, alert and stop.
              if (!modal || !instanceIdInput || !goButton || !stayButton) {
                alert(
                  "Configuration Error: The custom modal elements were not found in the HTML."
                );
                return;
              }

              // --- CUSTOM MODAL LOGIC ---

              // 1. Set the ID value and show the modal
              instanceIdInput.value = instanceId;
              modal.style.display = "block";

              // 2. Automatically select the text for quick Ctrl+C
              instanceIdInput.select();
              instanceIdInput.setSelectionRange(0, 99999); // For mobile compatibility

              // 3. Define button actions (using .onclick to ensure a fresh handler each time)

              // Go Button: Navigate to the new instance
              goButton.onclick = () => {
                const selectedSolver =
                  document.getElementById("solver-select").value;

                modal.style.display = "none";
                let newUrl = `?instance=${instanceId}`;

                // ✅ FIX: Use 'method' parameter instead of 'solver'
                if (selectedSolver.toLowerCase() === "ilp") {
                  newUrl += "&method=ilp";
                } else if (selectedSolver.toLowerCase() === "heuristic") {
                  newUrl += "&method=heuristic";
                } else if (selectedSolver.toLowerCase() === "hybrid") {
                  newUrl += "&method=hybrid";
                }

                // Keep the 90s theme if active
                if (isK00lModeActive) {
                  newUrl += "&theme=k00l90z";
                }

                window.location.href = newUrl;
              };

              // Stay Button: Close the modal and stay on the current page
              stayButton.onclick = () => {
                modal.style.display = "none";
              };

              // --- END CUSTOM MODAL LOGIC ---
            }
          } catch (err) {
            alert("⚠️ Network or server error: " + err.message);
          }

          // Reset input, falls gleiche Datei nochmal gewählt wird
          fileInput.value = "";
        });

        if (downloadButton) {
          // This logic handles activation/deactivation and download link setting

          // We MUST use the CSS variable here, not the hardcoded attribute
          const activeColor = getComputedStyle(document.documentElement)
            .getPropertyValue("--color-primary")
            .trim();

          if (
            currentInstanceId &&
            currentInstanceId.toLowerCase() !== "k00l90z"
          ) {
            // 1. Visually activate the button
            downloadButton.style.opacity = 1;
            downloadButton.style.cursor = "pointer";
            downloadButton.removeAttribute("title");

            // 2. Set the download handler
            downloadButton.addEventListener("click", () => {
              const downloadUrl = `/api/download/${currentInstanceId}.json`;
              // Trigger the download
              window.open(downloadUrl, "_blank");
            });
          } else {
            // Ensure the button is fully disabled if no instance is loaded OR if k00l90z mode is active
            downloadButton.style.opacity = 0.5;
            downloadButton.style.cursor = "not-allowed";
            // Restore disabled color using the variable
            const disabledColor = getComputedStyle(document.documentElement)
              .getPropertyValue("--color-button-disabled")
              .trim();
            downloadButton.style.background = disabledColor;
            downloadButton.setAttribute(
              "title",
              "Load an instance first to enable download."
            );

            // Remove any previous event listeners (optional, but clean)
            downloadButton.onclick = null;
          }
        }

        // --- Sample Dropdown Toggle & Population ---
        if (sampleButton && sampleDropdown && instanceIdInputHeader) {
          // Toggle visibility
          sampleButton.addEventListener("click", (event) => {
            event.stopPropagation();
            const isVisible = sampleDropdown.style.display === "block";
            sampleDropdown.style.display = isVisible ? "none" : "block";
          });

          // Handle clicks on the sample links
          sampleDropdown.querySelectorAll("a").forEach((link) => {
            link.addEventListener("click", (event) => {
              event.preventDefault(); // <-- IMPORTANT: Stop navigation

              const instanceId = link.getAttribute("data-instance");

              // 1. Put the text in the textbox
              instanceIdInputHeader.value = instanceId;

              // 2. Hide the dropdown
              sampleDropdown.style.display = "none";

              // Optional: Focus the "Go" button for quick selection
              goToInstanceButton.focus();
            });
          });

          // Hide the dropdown if the user clicks anywhere else on the page
          document.addEventListener("click", (event) => {
            if (
              !sampleDropdown.contains(event.target) &&
              event.target !== sampleButton
            ) {
              sampleDropdown.style.display = "none";
            }
          });
        }

        // --- Solver Dropdown Toggle & Selection ---
        if (solverButton && solverDropdown) {
          // Set initial solver based on URL parameter (default is 'heuristic')
          const currentSolver = urlParams.get("method") || "heuristic";
          let selectedSolver = currentSolver;

          // 1. Inizializzazione: Aggiorna il testo del pulsante al caricamento della pagina
          const formattedSolver =
            selectedSolver.slice(0) == "ilp" ? "ILP" : selectedSolver.slice(0);
          solverButton.innerHTML = `${formattedSolver} Solver <span style="font-size: 0.7em;">&#x25BC;</span>`;

          // Toggle visibility
          solverButton.addEventListener("click", (event) => {
            event.stopPropagation();
            const isVisible = solverDropdown.style.display === "block";
            solverDropdown.style.display = isVisible ? "none" : "block";
          });

          // Handle clicks on the solver links
          solverDropdown.querySelectorAll("a").forEach((link) => {
            link.addEventListener("click", (event) => {
              event.preventDefault();

              const solver = link.getAttribute("data-solver");
              selectedSolver = solver;

              // 2. Aggiornamento: Aggiorna il testo del pulsante dopo la selezione
              const formattedSolver =
                selectedSolver.charAt(0).toUpperCase() +
                selectedSolver.slice(1);
              solverButton.innerHTML = `${formattedSolver} Solver <span style="font-size: 0.7em;">&#x25BC;</span>`;

              // Hide the dropdown
              solverDropdown.style.display = "none";
            });
          });

          // Hide the dropdown if the user clicks anywhere else on the page
          document.addEventListener("click", (event) => {
            if (
              !solverDropdown.contains(event.target) &&
              event.target !== solverButton
            ) {
              solverDropdown.style.display = "none";
            }
          });

          // --- Single Go Button that handles both functions ---
          if (goToInstanceButton && instanceIdInputHeader) {
            goToInstanceButton.addEventListener("click", () => {
              const instanceId = instanceIdInputHeader.value.trim();

              // If the user attempts to 'Go' to k00l90z, only apply the theme to the current page/instance
              if (instanceId.toLowerCase() === "k00l90z") {
                // Get the real current instance ID from the URL, or empty string if none is loaded.
                const realInstance = urlParams.get("instance") || "";

                // Reload the page with the current instance and the new theme parameter
                window.location.href = `?instance=${realInstance}&theme=k00l90z`;
                return; // Stop here
              }

              // If input field is empty but we have a current instance, perform "Solve Again"
              if (!instanceId && currentInstanceId) {
                solveAgain(selectedSolver);
                return;
              }

              // If we have an instance ID in the input field, navigate to that instance
              if (instanceId) {
                let newUrl = `?instance=${instanceId}&method=${selectedSolver}`;
                if (isK00lModeActive) {
                  newUrl += "&theme=k00l90z";
                }
                window.location.href = newUrl;
                return;
              }

              // If neither condition is met, show an alert
              alert("Please enter a valid Instance ID.");
            });
          }
        }

        // Expose the current theme to the module script
        window.currentAppTheme = currentTheme;
      }); // <-- End of DOMContentLoaded listener
    </script>

    <div
      id="custom-modal"
      style="
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.6);
      "
    >
      <div
        class="modal-content-container"
        style="
          margin: 15% auto;
          padding: 20px;
          border: 1px solid #555;
          width: 80%;
          max-width: 400px;
          border-radius: 8px;
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.4);
        "
      >
        <h2 style="margin-top: 0">✅ Success!</h2>
        <p style="margin-bottom: 20px">
          Your new graph instance is ready. Copy the ID below:
        </p>

        <input
          type="text"
          id="instance-id-input"
          value=""
          readonly
          style="
            width: 95%;
            padding: 10px;
            margin-bottom: 20px;
            font-weight: bold;
            font-family: monospace;
            border-radius: 4px;
          "
        />
        <div style="margin-bottom: 20px">
          <label for="solver-select" style="display: block; margin-bottom: 5px"
            >Select Solver:</label
          >
          <select
            id="solver-select"
            style="
              width: 100%;
              padding: 8px;
              border-radius: 5px;
              border: 1px solid #ccc;
              font-family: var(--font-main);
              background-color: var(--color-background-medium);
              color: var(--color-text-input);
            "
          >
            <option value="ilp">ILP Solver</option>
            <option value="heuristic">Heuristic Solver</option>
            <option value="hybrid">Hybrid Solver</option>
          </select>
        </div>

        <div style="display: flex; justify-content: space-between">
          <button
            id="stay-button"
            style="
              padding: 10px 15px;
              border: none;
              border-radius: 5px;
              cursor: pointer;
              transition: background-color 0.2s;
            "
          >
            Stay Here
          </button>

          <button
            id="go-button"
            style="
              padding: 10px 15px;
              border: none;
              border-radius: 5px;
              cursor: pointer;
              font-weight: bold;
              transition: background-color 0.2s;
            "
          >
            Go to New Instance
          </button>
        </div>
      </div>
    </div>
  </body>
</html>
